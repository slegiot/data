services:
  # 1. The main Next.js Application
  - type: web
    name: silent-data-collector
    env: node
    buildCommand: npm install && npm run build
    startCommand: npm run start
    envVars:
      - key: NEXT_PUBLIC_SUPABASE_URL
        sync: false
      - key: NEXT_PUBLIC_SUPABASE_ANON_KEY
        sync: false
      - key: SUPABASE_SERVICE_ROLE_KEY
        sync: false
      - key: ADMIN_UUID
        sync: false
      - key: CRON_SECRET
        sync: false
      - key: NEXT_PUBLIC_SENTRY_DSN
        sync: false
      - key: SENTRY_AUTH_TOKEN
        sync: false
      - key: BROWSERLESS_WSS_URL
        # Set in Render dashboard â€” private service hostnames include a random suffix
        # Find it at: Render Dashboard > browserless-chrome > Connect > Internal hostname
        # Format: ws://<internal-hostname>:10000
        sync: false

  # 2. Cron job that triggers scraping on a schedule
  - type: cron
    name: collector-scraper-cron
    env: node
    buildCommand: npm install
    startCommand: node -e "fetch('https://silent-data-collector.onrender.com/api/cron/scrape',{headers:{'Authorization':'Bearer ' + process.env.CRON_SECRET}}).then(r=>r.json()).then(console.log).catch(console.error)"
    schedule: "0 * * * *"
    envVars:
      - key: CRON_SECRET
        sync: false

  # 3. Self-hosted Browserless Chrome (private Docker service)
  # Pulls a prebuilt headless Chromium image from Docker Hub.
  # Accessible via WebSocket on Render's internal network.
  - type: pserv
    name: browserless-chrome
    runtime: image
    image:
      url: docker.io/browserless/chrome:latest
    envVars:
      - key: MAX_CONCURRENT_SESSIONS
        value: "5"
      - key: CONNECTION_TIMEOUT
        value: "60000"
      - key: TOKEN
        value: ""
